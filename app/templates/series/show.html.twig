{% extends 'base.html.twig' %}

{% block title %}
	{{ series.title }}
{% endblock %}

{% block body %}

	{% include('./header.html.twig') with {'poster_picture_id': series.id} %}
	{% set url = series.youtubeTrailer | split('='	)[1] %}
	{% set totalSeriesCount = 0 %}
	{% set avgSeriesRates = 0 %}
	{% if app.user %}
		{% set userRating = ratings|filter(r => r.user.id == app.user.id)|first %}
	{% endif %}
	{% for r in ratings %}
		{% if series.id == r.series %}
			{% set totalSeriesCount = totalSeriesCount + 1 %}
			{% set avgSeriesRates = avgSeriesRates + r.value %}
		{% endif %}
	{% endfor %}
	{% if totalSeriesCount > 0 %}
		{% set avgSeriesRates = (avgSeriesRates / totalSeriesCount *10)|round /10 %}
	{% endif %}


	<iframe class="xl:hidden block absolute w-[100vw] h-[56vw] -translate-y-[20%] -z-[1000]" id="trailer" allow="autoplay" src="https://youtube.com/embed/{{url}}?controls=0&autoplay=1&mute=1&modestbranding=1&showinfo=0&rel=0&loop=1&cc_load_policy=1&showinfo=0autohide=2&playlist={{url}}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" style="-webkit-mask-image: linear-gradient(0deg, transparent 0,#030516 100%)"></iframe>
	<div x-data="{ following: {{ (app.user and app.user.getSeries().contains(series)) ? 'true' : 'false'}} }" class="flex sm:px-12 px-4 xl:py-12 pt-64 relative sm:flex-row flex-col">
		<div class="flex flex-col sm:items-left items-center">
			<div class="m-3 w-64 ">
				<div class="relative">
					<img src="{{ path('app_series_poster', {'id': series.id}) }}" alt="Series poster" class="w-full">
					{% include ('./percentage.html.twig') with {'percent': percentage_serie, 'name': "progress_bar_serie"} %}
				</div>
				<div class="bg-[--grey] p-2 rounded flex justify-around">
					{% if app.user %}
						<button @click="following = !following" onclick="follow('{{ path('app_series_update_followed', {'id': series.id, 'update': series.getId()}) }}')">
							<i id="season-follow-{{series.getId()}}" class="nf" :class="{ 'nf-fa-bookmark': following, 'nf-fa-bookmark_o': !following }"></i>
						</button>
						{% set episode = (series.getSeasons()|last).getEpisodes()|last %}
						<button id="see_all" onclick="mark_as_seen('{{ path('app_series_update', {'id': series.getId(), 'update': episode.getId()}) }}'	, true )">
							{% if percentage_serie == 100 %}
								<i id="ep-{{episode.getId()}}" class="nf nf-fa-check"></i>
							{% else %}
								<i id="ep-{{episode.getId()}}" class="nf nf-md-eye_off"></i>
							{% endif %}
						</button>
					{% else %}
						<a href="{{path('app_login')}}">Login to follow</a>
					{% endif %}
				</div>
			</div>
			<div class="m-3">
				<ul class="max-w-96">
					<h1 class="sm:hidden block text-3xl font-bold  text-white">{{ series.title }}</h1>

					<hr class="border-[--grey]">
					<li>
						<p class="text-[--white]">
							{% if series.imdb != "" %}
								<a href="https://www.imdb.com/title/{{ series.imdb }}">See more</a>
							{% else %}
								none
							{% endif %}
						</p>
					</li>
					<hr class="border-[--grey]">
					<li>
						<h2 class="font-bold text-[--grey]">Genre</h2>
						{% for genre in series.genre %}
							<button class="text-[--white] bg-[--grey] rounded m-1 ">{{ genre.name }}</button>
						{% endfor %}
					</li>
					<hr class="border-[--grey]">
					<li>
						<h2 class="font-bold text-[--grey]">Director</h2>
						<p class="text-[--white]">
							{% if series.director != "" %}
								{{ series.director }}
							{% else %}
								unknown
							{% endif %}
						</p>
					</li>
					<hr class="border-[--grey]">
					<li>
						<h2 class="font-bold text-[--grey]">Awards</h2>
						<p class="text-[--white]">
							{% if series.awards != "" %}
								{{ series.awards }}
							{% else %}
								none
							{% endif %}
						</p>
					</li>
					<hr class="border-[--grey]">
					<li>
						<h2 class="font-bold text-[--grey]">Series start</h2>
						<p class="text-[--white]">
							{{ series.yearStart }}</p>
					</li>
					<li>
						<h2 class="font-bold text-[--grey]">Series end</h2>
						<p class="text-[--white]">
							{% if series.yearEnd != null %}
								{{ series.yearEnd }}
							{% else %}
								still running
							{% endif %}
						</p>
					</li>
					<hr class="border-[--grey]">
				</ul>
			</div>
		</div>
		<div>
			<div class="m-3 flex flex-col">
				<div class="flex place-content-between w-[32rem] items-center">
					<h1 class="text-3xl font-bold  text-white">{{ series.title }}</h1>
					<div class="flex gap-1 justify-end items-center " style="width:-webkit-fill-available;">
						{% if app.user and not userRating %}
							<a class=" p-2 font-bold block" href="#post_your_rating">Post your rating</a>
						{% endif %}
						{% for i in 1..5 %}
							{% if i <= avgSeriesRates %}
								<i class="nf nf-fa-star text-yellow-500"></i>
							{% else %}
								<i class="nf nf-fa-star text-[--grey]"></i>
							{% endif %}
						{% endfor %}
						<p class="text-[--grey]">{{ ratings|length }}</p>
					</div>
				</div>
				<p class="md:w-1/2 px-2 py-5 text-base">
					<span>&emsp;</span>
					<span>&emsp;</span>
					{{ series.plot | raw}}</p>
				{# <hr class="border-[--grey] m-2"> #}
				<div method="get" id="seasons_episodes" class="flex justify-around flex-wrap flex-col gap-1 m-3 py-10">
					<div class="flex gap-1" id="seasons">
						{% for season in series.getSeasons() %}
							<div id="season-{{ loop.index }}" class="relative rounded overflow-hidden">
								<button onclick="show_season({{loop.index}})" class="text-white p-2 ">Season
									{{ season.getNumber() }}</button>

								{% set progressBarId = "progress_bar_season_" ~ (loop.index) %}
								{% include ('./percentage.html.twig') with {'percent': percentages_seasons[loop.index-1], "name": progressBarId } %}
							</div>
						{% endfor %}
					</div>
					{% for season in series.getSeasons() %}
						{% set season_id = loop.index %}
						<div id="ep-season-{{ loop.index }}">
							{% for episode in season.getEpisodes() %}
								<div>
									{% if is_granted('ROLE_USER') %}
										<button onclick="mark_as_seen('{{ path('app_series_update', {'id': series.getId(), 'update': episode.getId()}) }}')">
											{% if app.user.getEpisode().contains(episode) %}
												<i id="ep-{{episode.getId()}}" class="nf nf-fa-check"></i>
											{% else %}
												<i @click="following = true" id="ep-{{episode.getId()}}" class="nf nf-md-eye_off"></i>
											{% endif %}
										</button>
									{% endif %}
									{{ episode.getNumber() }}
									-
									<span>{{ episode.getTitle() }}</span>
								</div>
							{% endfor %}
						</div>
					{% endfor %}
				</div>
			</div>
		</div>
		{% set url = series.youtubeTrailer | split('='	)[1] %}
		<iframe style=" -webkit-mask-image: radial-gradient(closest-side,#030516 0%, transparent 85%);" class="xl:block hidden absolute top-0 right-0 w-1/2 h-1/2 -z-10" width="560" id="trailer" height="315" allow="autoplay" src="https://youtube.com/embed/{{url}}?controls=0&autoplay=1&mute=1&modestbranding=1&showinfo=0&rel=0&loop=1&cc_load_policy=1&showinfo=0autohide=2&playlist={{url}}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
	</div>
	<div class="text-white bg-gray p-4">
		<div class="text-4xl flex items-center">
			{{ avgSeriesRates }}/5
			<div class="nf nf-fa-star text-3xl ml-1"></div>
		</div>
		<div class="text-sm mb-4">
			{{totalSeriesCount}}
			ratings</div>
		<div class="flex items-center space-x-1">
			{% for i in 1..5 %}
				<i class="fas fa-star {{ i <= 4 ? 'text-yellow-500' : 'text-yellow-300' }}"></i>
			{% endfor %}
		</div>
		<div class="flex flex-col-reverse ">
			{% for index, count in ratings_displayed %}
				{% if index != 0 %}
					{% if totalSeriesCount != 0 %}
						{% set percentage = ((count / totalSeriesCount)* 1000)|round  / 10 %}
					{% else %}
						{% set percentage = 0 %}
					{% endif %}
					<div class="flex items-center gap-1">
						<div class="w-5 text-right ">{{ index }}</div>
						<div class="nf nf-fa-star ml-1 mb-0.5"></div>
						<div class="w-1/5 h-2 bg-gray-500 rounded-full ml-2">
							<div class="h-full bg-yellow-500 rounded-full" style="width: {{ percentage }}%;"></div>
						</div>
						<div class="ml-2">{{ percentage }}%</div>
					</div>
				{% endif %}
			{% endfor %}
		</div>


		{% if app.user %}
			{% if not userRating %}
				<div>You've not reviewed this serie yet!</div>
				<div class="xl:absolute xl:bottom-8 xl:right-8">
					<div class="max-w-md mx-auto p-4 bg-grey shadow-lg rounded-md">
						{{ form_start(ratingForm, {'method': 'POST'}, {'attr': {'class': 'mb-4'}}) }}
						<div class="mb-4 ">
							{{ form_row(ratingForm.value, {'attr': {'class': 'w-full px-3 py-2 border border-gray-300 rounded-md text-[--grey]'}}) }}
							{{ form_errors(ratingForm.value) }}
						</div>

						<div class="mb-4">
							{{ form_row(ratingForm.comment, {'attr': {'class': 'w-full px-3 py-2 border border-gray-300 rounded-md text-[--grey]'}}) }}
							{{ form_errors(ratingForm.comment) }}
						</div>

						<button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md">
							Noter la s√©rie
						</button>

						{% for success in app.flashes('success') %}
							<p>{{ success }}</p>
						{% endfor %}

						{{ form_end(ratingForm) }}
					</div>
				</div>
			</div>
		{% endif %}
	{% endif %}
	{% for r in ratings %}
		{% if app.user and r.user.id == app.user.id%}
			<div class="ml-2 mt-4 border border-gray-300 p-4 rounded-md w-1/5">
				<div class="font-bold text-xl">Your rating</div>
				<div class="flex gap-4 ">
					<div class="flex items-center">
						{% for i in 1..5 %}
							{% if i <= userRating.value %}
								<i class="nf nf-fa-star text-yellow-500"></i>
							{% else %}
								<i class="nf nf-fa-star text-[--grey]"></i>
							{% endif %}
						{% endfor %}
					</div>
					<div class="mt-2 text-gray-200">{{ userRating.comment }}</div>
				</div>
			</div>
		{% else %}
			<div class="flex m-4 items-center gap-2">
				<a href="{{path('app_user_show', {'id': r.user.id })}}">{{r.user.name}}</a>
				<div>
					{% for i in 1..5 %}
						{% if i <= r.value %}
							<i class="nf nf-fa-star text-yellow-500"></i>
						{% else %}
							<i class="nf nf-fa-star text-[--grey]"></i>
						{% endif %}
					{% endfor %}
				</div>
			</div>
		{% endif %}
	{% endfor %}


	<a href="{{ path('app_series_index') }}" class="text-[--white] text-center text-2xl font-bold block">
		<i class="nf nf-md-keyboard_backspace"></i>
		Back to list</a>

	<script src="{{asset("follow.js")}}"></script>
	<script>
		function show_season(season){
			{% for season in series.getSeasons() %}
document.getElementById("ep-season-{{ loop.index }}").style.display = "none";
document.getElementById("season-{{ loop.index }}").classList.remove("current");{% endfor %}document.getElementById("ep-season-" + season).style.display = "block";
document.getElementById("season-" + season).classList.add("current");
}
show_season(1)
	</script>
{% endblock %}
